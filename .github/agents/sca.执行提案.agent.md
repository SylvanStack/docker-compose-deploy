---
description: 实施已批准的 OpenSpec 变更提案，按顺序执行 tasks.md 中的任务
handoffs:
  - label: 归档变更
    agent: sca.归档变更
    prompt: 归档此变更
    send: true
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，你**必须**考虑用户输入（如果非空）。

## 防护栏

- 优先采用简单直接、最小化的实现，仅在明确请求或明显需要时才增加复杂性。
- 将变更严格限定在请求的结果范围内。
- 如果需要额外的 OpenSpec 约定或澄清，请参考 `openspec/AGENTS.md`（位于 `openspec/` 目录内——如果看不到，运行 `ls openspec` 或 `openspec update`）。

## 大纲

将这些步骤作为 TODO 跟踪并逐一完成。

### 1. 确定变更 ID

- 如果用户输入包含特定的变更 ID，使用该值
- 否则运行 `openspec list` 查看活跃的变更
- 如果有多个变更，询问用户要实施哪一个
- 验证变更存在且包含完整的提案文档

### 2. 加载实施上下文

**必需文档**：
- 读取 `openspec/changes/<id>/proposal.md` - 了解变更的目的和范围
- 读取 `openspec/changes/<id>/tasks.md` - 获取完整的任务清单
- 读取 `openspec/changes/<id>/design.md`（如果存在）- 了解技术决策和架构

**规范增量**（可选但推荐）：
- 检查 `openspec/changes/<id>/specs/` 目录
- 读取相关的规范增量以理解新需求和场景

**项目约定**：
- 读取 `openspec/project.md` 了解代码风格和架构模式

### 3. 检查任务状态

扫描 `tasks.md` 文件：
- 统计总任务数：所有匹配 `- [ ]` 或 `- [x]` 的行
- 统计已完成任务：匹配 `- [x]` 的行
- 统计未完成任务：匹配 `- [ ]` 的行

显示状态摘要：
```text
任务状态：
- 总计：N 个任务
- 已完成：M 个任务 
- 待完成：K 个任务
```

如果有任务已完成但代码未实施，警告可能的状态不一致。

### 4. 按顺序执行任务

对于 `tasks.md` 中的每个未完成任务：

**4.1 任务分析**
- 明确任务的具体目标
- 识别需要修改的文件
- 确定任务的验收标准

**4.2 最小化实施**
- 仅实施当前任务所需的变更
- 保持编辑范围最小
- 遵循项目的代码风格和约定
- 优先使用现有模式而非引入新复杂性

**4.3 验证实施**
- 检查语法错误
- 确认变更符合任务描述
- 验证不会破坏现有功能

**4.4 更新任务状态**
- **仅在任务完全完成后**，将任务标记为 `- [x]`
- 在 `tasks.md` 文件中更新对应行

**4.5 进度报告**
- 告知用户任务已完成
- 提供简短的变更摘要
- 如果遇到问题，立即报告并等待指示

### 5. 完成检查

所有任务完成后：

**5.1 验证完整性**
- 确认 `tasks.md` 中所有任务都标记为 `- [x]`
- 运行 `openspec validate --strict --no-interactive` 验证项目状态
- 检查是否有编译错误或测试失败

**5.2 生成摘要**
创建实施摘要报告：
```text
✓ 实施完成

变更 ID：<id>
已完成任务：N/N
修改的文件：
- file1.ext
- file2.ext
- ...

主要变更：
- 变更点 1
- 变更点 2
- ...

验证状态：[通过/失败]
```

**5.3 下一步建议**
- 如果验证通过，建议用户测试变更
- 提示可以使用 `/openspec:archive <id>` 归档此变更
- 如果有问题，列出需要解决的事项

## 参考命令

```bash
# 查看活跃的变更
openspec list

# 查看特定变更的详细信息
openspec show <id>

# 查看变更的规范增量
openspec show <id> --json --deltas-only

# 验证项目状态
openspec validate --strict --no-interactive
```

## 错误处理

- **找不到变更 ID**：运行 `openspec list` 并让用户选择
- **缺少必需文档**：告知用户并停止，建议先运行 `/openspec:proposal`
- **任务描述不明确**：向用户请求澄清，不要猜测
- **遇到冲突或错误**：立即停止，报告问题，等待用户指示
- **验证失败**：显示具体错误，询问是否继续还是修复

## 最佳实践

1. **增量进展**：一次完成一个任务，立即更新状态
2. **保持简单**：默认选择最直接的实现
3. **频繁沟通**：完成每个任务后报告进度
4. **尊重约定**：遵循 `openspec/project.md` 中的项目规范
5. **验证优先**：在标记任务完成前确保实施正确
